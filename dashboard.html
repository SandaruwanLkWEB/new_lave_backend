<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - DSI Leave System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/css/theme.css" rel="stylesheet">
</head>
<body>
  <div id="appTopbar"></div>
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

  <div class="container-xl py-4">
    <div class="card p-3 p-md-4">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2">
        <div>
          <h3 class="fw-bold mb-1">Dashboard</h3>
          <div class="small-muted">Summary for HR / ADMIN.</div>
        </div>
        <button class="btn btn-outline-primary" id="btnRefresh">Refresh</button>
      </div>
    </div>

    <div class="row g-3 section-gap" id="kpis"></div>

    <div class="row g-3 section-gap">
      <div class="col-12 col-lg-7">
        <div class="card p-3 p-md-4">
          <div class="fw-bold mb-2">Recent Requests</div>
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead><tr><th>ID</th><th>Name</th><th>Dept</th><th>Date</th><th>Planned</th><th>Status</th></tr></thead>
              <tbody id="recent"><tr><td colspan="6" class="small-muted">Loading…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="card p-3 p-md-4">
          <div class="fw-bold mb-2">Status Counts</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead><tr><th>Status</th><th class="text-end">Count</th></tr></thead>
              <tbody id="counts"><tr><td colspan="2" class="small-muted">Loading…</td></tr></tbody>
            </table>
          </div>
          <div class="small-muted mt-2" id="secPending"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/i18n.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/layout.js"></script>

  <script>
    requireAuth();
    renderTopbar("dashboard.html");

    function ensureRole(){
      const r=String(getUser()?.role||"").toUpperCase();
      if(!(r==="HR" || r==="ADMIN")){
        location.href = roleHome(r);
        return false;
      }
      return true;
    }

    function statusBadge(status){
      const s=(status||"—").toString();
      const cls=s.includes("FINAL_APPROVED")||s==="AUTO_CLOSED" ? "bg-approved" :
                (s.includes("FINAL_REJECTED")||s.includes("REJECTED")) ? "bg-rejected" :
                (s.includes("APPEAL")) ? "bg-appealed" : "bg-pending";
      return `<span class="badge ${cls}">${escapeHtml(s)}</span>`;
    }

    async function loadDash(){
      if(!ensureRole()) return;
      const kpis=document.getElementById("kpis");
      const recent=document.getElementById("recent");
      const counts=document.getElementById("counts");
      const secPending=document.getElementById("secPending");
      kpis.innerHTML="";
      recent.innerHTML=`<tr><td colspan="6" class="small-muted">Loading…</td></tr>`;
      counts.innerHTML=`<tr><td colspan="2" class="small-muted">Loading…</td></tr>`;
      secPending.textContent="";

      try{
        const res=await apiFetch("/api/dashboard/summary");
        const today=res.today_totals || {};
        const cards=[
          ["Today Requests", today.requests ?? "—"],
          ["Today Planned Minutes", today.planned_minutes ?? "—"],
          ["Security Pending", res.security_pending ?? "—"],
        ];
        cards.forEach(([label,value])=>{
          const col=document.createElement("div");
          col.className="col-12 col-sm-6 col-lg-4";
          col.innerHTML=`<div class="card p-3"><div class="kpi"><div><div class="label">${escapeHtml(label)}</div><div class="value">${escapeHtml(value)}</div></div><div class="badge text-bg-primary">KPI</div></div></div>`;
          kpis.appendChild(col);
        });

        const r = res.recent || [];
        if(!r.length){ recent.innerHTML=`<tr><td colspan="6" class="small-muted">No recent.</td></tr>`; }
        else{
          recent.innerHTML="";
          r.forEach(x=>{
            const planned=`${String(x.planned_out||"").slice(0,5)}-${String(x.planned_in||"").slice(0,5)}`;
            recent.insertAdjacentHTML("beforeend",`
              <tr>
                <td>#${escapeHtml(x.id)}</td>
                <td>${escapeHtml(x.full_name||"—")}${x.is_unregistered ? ` <span class="badge bg-appealed">UNREG</span>`:""}</td>
                <td>${escapeHtml(x.department_name||"—")}</td>
                <td>${escapeHtml(String(x.date||"").slice(0,10))}</td>
                <td>${escapeHtml(planned)}</td>
                <td>${statusBadge(x.status)}</td>
              </tr>
            `);
          });
        }

        const sc=res.status_counts||[];
        if(!sc.length){ counts.innerHTML=`<tr><td colspan="2" class="small-muted">No data</td></tr>`; }
        else{
          counts.innerHTML="";
          sc.forEach(s=>{
            counts.insertAdjacentHTML("beforeend", `<tr><td>${escapeHtml(s.status)}</td><td class="text-end">${escapeHtml(s.count)}</td></tr>`);
          });
        }
        secPending.textContent = `Leaves waiting OUT/IN: ${res.security_pending ?? 0}`;
      }catch(e){
        showToast(e.message,"danger");
      }
    }

    document.getElementById("btnRefresh").addEventListener("click", loadDash);
    loadDash();
  </script>
</body>
</html>
