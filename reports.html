<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reports - DSI Leave System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/css/theme.css" rel="stylesheet">
</head>
<body>
  <div id="appTopbar"></div>
  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

  <div class="container-xl py-4">
    <div class="card p-3 p-md-4">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2">
        <div>
          <h3 class="fw-bold mb-1" id="lblTitle">Reports</h3>
          <div class="small-muted" id="lblSub">Daily / Monthly / Yearly (HR / ADMIN).</div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" id="btnDownload">CSV Download</button>
          <button class="btn btn-outline-primary" id="btnDownloadXlsx">XLSX Download</button>
          <button class="btn btn-primary" id="btnRun">Run</button>
        </div>
      </div>
    </div>

    <div class="card p-3 p-md-4 section-gap">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" id="lblType">Type</label>
          <select class="form-select" id="type">
            <option value="daily">Daily</option>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
            <option value="trends">Trends</option>
          </select>
        </div>

        <div class="col-12 col-md-3" id="dailyBox">
          <label class="form-label fw-bold" id="lblDate">Date</label>
          <input class="form-control" type="date" id="date">
        </div>

        <div class="col-6 col-md-2" id="monthBox">
          <label class="form-label fw-bold" id="lblMonth">Month</label>
          <input class="form-control" type="number" min="1" max="12" id="month">
        </div>

        <div class="col-6 col-md-2" id="yearBox">
          <label class="form-label fw-bold" id="lblYear">Year</label>
          <input class="form-control" type="number" min="2020" max="2100" id="year">
        </div>

        <div class="col-12 col-md-2" id="trendFromBox" style="display:none;">
          <label class="form-label fw-bold">From</label>
          <input class="form-control" type="date" id="from">
        </div>

        <div class="col-12 col-md-2" id="trendToBox" style="display:none;">
          <label class="form-label fw-bold">To</label>
          <input class="form-control" type="date" id="to">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" id="lblDept">Department</label>
          <select class="form-select" id="department_id">
            <option value="">All</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" id="lblEmp">Emp No / Name</label>
          <input class="form-control" type="text" id="emp_no" placeholder="E001 / Name">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label fw-bold" id="lblStatus">Status</label>
          <select class="form-select" id="status">
            <option value="">All</option>
            <option value="PENDING_HOD">PENDING_HOD</option>
            <option value="PENDING_ADMIN">PENDING_ADMIN</option>
            <option value="PENDING_HR">PENDING_HR</option>
            <option value="FINAL_APPROVED">FINAL_APPROVED</option>
            <option value="FINAL_REJECTED">FINAL_REJECTED</option>
            <option value="REJECTED_HOD">REJECTED_HOD</option>
            <option value="REJECTED_ADMIN">REJECTED_ADMIN</option>
            <option value="APPEAL_PENDING_HR">APPEAL_PENDING_HR</option>
          </select>
        </div>

        <div class="col-12 col-md-3 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="unregistered">
            <label class="form-check-label fw-bold" for="unregistered" id="lblUnreg">Unregistered only</label>
          </div>
        </div>

        <div class="col-12">
          <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
            <div class="small-muted" id="meta">—</div>
            <div class="d-flex gap-2" id="pager" style="display:none;">
              <select class="form-select" id="limit" style="max-width:140px;">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200" selected>200</option>
              </select>
              <button class="btn btn-outline-primary" id="btnPrev">Prev</button>
              <button class="btn btn-outline-primary" id="btnNext">Next</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card p-3 p-md-4 section-gap">
      <div class="fw-bold mb-2" id="title">Results</div>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead id="thead"></thead>
          <tbody id="tbody"><tr><td class="small-muted">Run report to load data.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/i18n.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/layout.js"></script>

  <script>
    requireAuth();
    renderTopbar("reports.html");

    // i18n labels
    document.getElementById('lblTitle').textContent = t('reports.title') || 'Reports';
    document.getElementById('lblSub').textContent = t('reports.subtitle') || 'Daily / Monthly / Yearly (HR / ADMIN).';
    document.getElementById('lblType').textContent = t('reports.type') || 'Type';
    document.getElementById('lblDate').textContent = t('reports.date') || 'Date';
    document.getElementById('lblMonth').textContent = t('reports.month') || 'Month';
    document.getElementById('lblYear').textContent = t('reports.year') || 'Year';
    document.getElementById('lblDept').textContent = t('reports.department') || 'Department';
    document.getElementById('lblEmp').textContent = t('reports.employee') || 'Emp No / Name';
    document.getElementById('lblStatus').textContent = t('reports.status') || 'Status';
    document.getElementById('lblUnreg').textContent = t('reports.unregistered') || 'Unregistered only';
    document.getElementById('btnRun').textContent = t('common.run') || 'Run';
    document.getElementById('btnDownload').textContent = t('common.download_csv') || 'CSV Download';
    document.getElementById('btnDownloadXlsx').textContent = t('common.download_xlsx') || 'XLSX Download';

    function ensureRole(){
      const r=String(getUser()?.role||"").toUpperCase();
      if(!(r==="HR" || r==="ADMIN")){
        showToast("Access denied (HR/ADMIN only)","danger");
        setTimeout(()=>location.href=roleHome(r), 400);
        return false;
      }
      return true;
    }

    function setBoxes(){
      const t=document.getElementById("type").value;
      document.getElementById("dailyBox").style.display = (t==="daily") ? "" : "none";
      document.getElementById("monthBox").style.display = (t==="monthly") ? "" : "none";
      document.getElementById("yearBox").style.display = (t==="monthly" || t==="yearly") ? "" : "none";
      document.getElementById("trendFromBox").style.display = (t==="trends") ? "" : "none";
      document.getElementById("trendToBox").style.display = (t==="trends") ? "" : "none";
      document.getElementById("pager").style.display = (t==="daily") ? "" : "none";
    }

    function th(html){ document.getElementById("thead").innerHTML = html; }
    function tb(html){ document.getElementById("tbody").innerHTML = html; }

    function buildQuery(extra={}){
      const params = new URLSearchParams();
      const dep = document.getElementById('department_id').value;
      const emp = document.getElementById('emp_no').value.trim();
      const status = document.getElementById('status').value;
      const unreg = document.getElementById('unregistered').checked;
      if (dep) params.set('department_id', dep);
      if (emp) params.set('emp_no', emp);
      if (status) params.set('status', status);
      if (unreg) params.set('unregistered', '1');
      Object.entries(extra).forEach(([k,v])=>{ if (v !== undefined && v !== null && v !== '') params.set(k, v); });
      const q = params.toString();
      return q ? ('?' + q) : '';
    }

    function statusPill(status){
      const cls = statusBadgeClass(status);
      return `<span class="badge ${cls}">${escapeHtml(formatStatus(status))}</span>`;
    }

    let currentOffset = 0;

    async function run(){
      if(!ensureRole()) return;
      const ttype=document.getElementById("type").value;
      const meta=document.getElementById("meta");
      meta.textContent = t('common.loading') || 'Loading…';
      tb(`<tr><td class="small-muted">${escapeHtml(t('common.loading')||'Loading…')}</td></tr>`);

      try{
        if(ttype==="daily"){
          const date=document.getElementById("date").value;
          const limit=document.getElementById('limit').value;
          const q = buildQuery({ date, limit, offset: currentOffset });
          const res=await apiFetch("/api/reports/daily"+q);
          document.getElementById("title").textContent = `Daily Report ${res.date ? '('+res.date+')' : ''}`;
          const total = res.pagination?.total || 0;
          const shown = (res.rows||[]).length;
          meta.textContent = `${shown} / ${total} records`;

          th(`<tr><th>ID</th><th>Emp No</th><th>Name</th><th>Dept</th><th>Date</th><th>Planned</th><th class="text-end">Planned Min</th><th class="text-end">Actual Min</th><th>Status</th></tr>`);
          const rows=res.rows||[];
          if(!rows.length){ tb(`<tr><td colspan="9" class="small-muted">No records</td></tr>`); return; }
          tb(rows.map(r=>{
            const planned = `${String(r.planned_out||"").slice(0,5)}-${String(r.planned_in||"").slice(0,5)}`;
            const actual = (r.actual_out && r.actual_in) ? `${String(r.actual_out).slice(0,5)}-${String(r.actual_in).slice(0,5)}` : '—';
            return `<tr>
              <td>#${escapeHtml(r.id)}</td>
              <td>${escapeHtml(r.emp_no||"—")}</td>
              <td>${escapeHtml(r.full_name||"—")}${r.is_unregistered?` <span class="badge bg-appealed">UNREG</span>`:""}</td>
              <td>${escapeHtml(r.department_name||"—")}</td>
              <td>${escapeHtml(String(r.date||"").slice(0,10))}</td>
              <td>${escapeHtml(planned)}<div class="small-muted">${escapeHtml(actual)}</div></td>
              <td class="text-end">${escapeHtml(Math.round(Number(r.planned_minutes||0)))}</td>
              <td class="text-end">${r.actual_minutes==null ? '—' : escapeHtml(Math.round(Number(r.actual_minutes||0)))}</td>
              <td>${statusPill(r.status||"—")}</td>
            </tr>`;
          }).join(""));

        } else if(ttype==="monthly"){
          const year=Number(document.getElementById("year").value);
          const month=Number(document.getElementById("month").value);
          const q = buildQuery({ year, month });
          const res=await apiFetch(`/api/reports/monthly${q}`);
          document.getElementById("title").textContent = `Monthly Report (${res.year}-${String(res.month).padStart(2,'0')})`;
          const emp=res.by_employee||[];
          const dept=res.by_department||[];
          meta.textContent = `Employees: ${emp.length} | Departments: ${dept.length}`;
          th(`<tr><th colspan="5">Top Employees</th></tr>
              <tr><th>Emp No</th><th>Name</th><th class="text-end">Requests</th><th class="text-end">Planned Min</th><th class="text-end">Actual Min</th></tr>`);
          let html = "";
          if(!emp.length) html += `<tr><td colspan="5" class="small-muted">No employee data</td></tr>`;
          else html += emp.map(r=>`<tr><td>${escapeHtml(r.emp_no)}</td><td>${escapeHtml(r.full_name)}${r.is_unregistered?` <span class="badge bg-appealed">UNREG</span>`:""}</td><td class="text-end">${escapeHtml(r.requests)}</td><td class="text-end">${escapeHtml(r.planned_minutes)}</td><td class="text-end">${escapeHtml(r.actual_minutes)}</td></tr>`).join("");
          html += `<tr><td colspan="5" style="height:12px;"></td></tr>`;
          html += `<tr><th colspan="5">By Department</th></tr>`;
          html += `<tr><th colspan="2">Dept</th><th class="text-end">Requests</th><th class="text-end">Planned Min</th><th class="text-end">Actual Min</th></tr>`;
          if(!dept.length) html += `<tr><td colspan="5" class="small-muted">No department data</td></tr>`;
          else html += dept.map(r=>`<tr><td colspan="2">${escapeHtml(r.name||"—")}</td><td class="text-end">${escapeHtml(r.requests)}</td><td class="text-end">${escapeHtml(r.planned_minutes)}</td><td class="text-end">${escapeHtml(r.actual_minutes)}</td></tr>`).join("");
          tb(html);

        } else if(ttype==="yearly"){
          const year=Number(document.getElementById("year").value);
          const q = buildQuery({ year });
          const res=await apiFetch(`/api/reports/yearly${q}`);
          document.getElementById("title").textContent = `Yearly Report (${res.year})`;
          const emp=res.by_employee||[];
          const dept=res.by_department||[];
          meta.textContent = `Employees: ${emp.length} | Departments: ${dept.length}`;
          th(`<tr><th colspan="5">Top Employees</th></tr>
              <tr><th>Emp No</th><th>Name</th><th class="text-end">Requests</th><th class="text-end">Planned Min</th><th class="text-end">Actual Min</th></tr>`);
          let html="";
          if(!emp.length) html += `<tr><td colspan="5" class="small-muted">No employee data</td></tr>`;
          else html += emp.map(r=>`<tr><td>${escapeHtml(r.emp_no)}</td><td>${escapeHtml(r.full_name)}${r.is_unregistered?` <span class="badge bg-appealed">UNREG</span>`:""}</td><td class="text-end">${escapeHtml(r.requests)}</td><td class="text-end">${escapeHtml(r.planned_minutes)}</td><td class="text-end">${escapeHtml(r.actual_minutes)}</td></tr>`).join("");
          html += `<tr><td colspan="5" style="height:12px;"></td></tr>`;
          html += `<tr><th colspan="5">By Department</th></tr>`;
          html += `<tr><th colspan="2">Dept</th><th class="text-end">Requests</th><th class="text-end">Planned Min</th><th class="text-end">Actual Min</th></tr>`;
          if(!dept.length) html += `<tr><td colspan="5" class="small-muted">No department data</td></tr>`;
          else html += dept.map(r=>`<tr><td colspan="2">${escapeHtml(r.name||"—")}</td><td class="text-end">${escapeHtml(r.requests)}</td><td class="text-end">${escapeHtml(r.planned_minutes)}</td><td class="text-end">${escapeHtml(r.actual_minutes)}</td></tr>`).join("");
          tb(html);

        } else {
          const from=document.getElementById('from').value;
          const to=document.getElementById('to').value;
          const q = buildQuery({ from, to, group:'day' });
          const res=await apiFetch(`/api/reports/trends${q}`);
          document.getElementById("title").textContent = `Trends (${res.from} → ${res.to})`;
          meta.textContent = `${(res.rows||[]).length} buckets`;
          th(`<tr><th>Date</th><th class="text-end">Requests</th><th class="text-end">Planned Min</th><th class="text-end">Actual Min</th></tr>`);
          const rows=res.rows||[];
          if(!rows.length){ tb(`<tr><td colspan="4" class="small-muted">No data</td></tr>`); return; }
          tb(rows.map(r=>`<tr><td>${escapeHtml(String(r.bucket).slice(0,10))}</td><td class="text-end">${escapeHtml(r.requests)}</td><td class="text-end">${escapeHtml(r.planned_minutes)}</td><td class="text-end">${escapeHtml(r.actual_minutes)}</td></tr>`).join(''));
        }
      }catch(e){
        meta.textContent="—";
        tb(`<tr><td class="text-danger small">${escapeHtml(e.message)}</td></tr>`);
      }
    }

    async function downloadCSV(){
      if(!ensureRole()) return;
      const type=document.getElementById("type").value;
      if(type!=='daily'){ showToast('CSV export supports Daily only. Use XLSX.','warning'); return; }
      const extra={ format:'csv', type };
      extra.date=document.getElementById('date').value;

      const q = buildQuery(extra);
      try{
        const token = getToken();
        const res = await fetch(`${BASE_URL}/api/reports/export${q}`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        if(!res.ok){
          const txt = await res.text();
          throw new Error(txt || `HTTP ${res.status}`);
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${type}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('Downloaded','success');
      }catch(e){
        showToast(e.message,'danger');
      }
    }

    async function downloadXLSX(){
      if(!ensureRole()) return;
      const type=document.getElementById("type").value;
      const extra={ format:'xlsx', type };
      if(type==='daily') extra.date=document.getElementById('date').value;
      if(type==='monthly'){ extra.year=document.getElementById('year').value; extra.month=document.getElementById('month').value; }
      if(type==='yearly'){ extra.year=document.getElementById('year').value; }
      if(type==='trends'){ extra.from=document.getElementById('from').value; extra.to=document.getElementById('to').value; extra.group='day'; }

      const q = buildQuery(extra);
      try{
        const token = getToken();
        const res = await fetch(`${BASE_URL}/api/reports/export${q}`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        if(!res.ok){
          const txt = await res.text();
          throw new Error(txt || `HTTP ${res.status}`);
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${type}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('Downloaded','success');
      }catch(e){
        showToast(e.message,'danger');
      }
    }

async function loadDepartments(){
      try{
        const res = await apiFetch('/api/public/departments');
        const sel = document.getElementById('department_id');
        (res.rows||[]).forEach(d=>{
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.name;
          sel.appendChild(opt);
        });
      }catch(e){ /* ignore */ }
    }

    const now=new Date();
    document.getElementById("date").valueAsDate=now;
    document.getElementById("year").value=now.getFullYear();
    document.getElementById("month").value=now.getMonth()+1;
    // default trends range: last 7 days
    const from = new Date(now); from.setDate(from.getDate()-7);
    document.getElementById('from').valueAsDate = from;
    document.getElementById('to').valueAsDate = now;

    document.getElementById("type").addEventListener("change", ()=>{ currentOffset=0; setBoxes(); });
    document.getElementById("btnRun").addEventListener("click", run);
    document.getElementById("btnDownload").addEventListener("click", downloadCSV);
    document.getElementById("btnDownloadXlsx").addEventListener("click", downloadXLSX);
    document.getElementById('btnPrev').addEventListener('click', ()=>{ currentOffset=Math.max(0, currentOffset - Number(document.getElementById('limit').value)); run(); });
    document.getElementById('btnNext').addEventListener('click', ()=>{ currentOffset=currentOffset + Number(document.getElementById('limit').value); run(); });
    document.getElementById('limit').addEventListener('change', ()=>{ currentOffset=0; run(); });

    setBoxes();
    loadDepartments();
  </script>
</body>
</html>
